generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "mongodb"
  url      = env("DATABASE_URL")
}

enum Role {
  ADMIN
  ACCOUNT_MANAGER
  TOWN_MANAGER
  TOWN_EMPLOYEE
}

enum ContributionType {
  ALERT
  SUGGESTION
}

enum ContributionStatus {
  OPEN
  CLOSED
}

enum BugReportType {
  BUG
  FEATURE
}

enum BugReportStatus {
  TO_BE_QUALIFIED
  TO_DO
  IN_PROGRESS
  DEPLOYED
  DONE
}

enum ContactTicketType {
  COMMUNE
  ORGANISME_FINANCIER
}

enum ContactTicketStatus {
  PENDING
  RESOLVED
}

enum CityAuditAction {
  CREATED
  UPDATED
}

model User {
  id                String             @id @default(auto()) @map("_id") @db.ObjectId
  email             String             @unique
  password          String
  firstName         String?
  lastName          String?
  phone             String?
  role              Role               @default(ADMIN)
  commune           Commune?           @relation(fields: [communeId], references: [id], onDelete: SetNull, onUpdate: NoAction)
  communeId         String?            @db.ObjectId
  createdAt         DateTime           @default(now())
  updatedAt         DateTime           @updatedAt
  lastLoginAt       DateTime?
  loginLogs         UserLoginLog[]
  cityAuditLogs     CityAuditLog[]
  createdCommunes   Commune[]          @relation("CommuneCreatedBy")
  updatedCommunes   Commune[]          @relation("CommuneUpdatedBy")
  closedReports     Contribution[]     @relation("ContributionClosedBy")
  contactTickets    ContactTicket[]
  bugReportComments BugReportComment[]
}

model Commune {
  id          String   @id @default(auto()) @map("_id") @db.ObjectId
  name        String
  slug        String?  @unique
  postalCode  String   @unique
  osmId       String   @unique
  osmType     String
  bbox        Float[]
  latitude    Float
  longitude   Float
  country     String   @default("FR")
  websiteUrl  String?
  isVisible   Boolean  @default(true)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  createdById String?  @db.ObjectId
  createdBy   User?    @relation("CommuneCreatedBy", fields: [createdById], references: [id], onDelete: NoAction, onUpdate: NoAction)
  updatedById String?  @db.ObjectId
  updatedBy   User?    @relation("CommuneUpdatedBy", fields: [updatedById], references: [id], onDelete: NoAction, onUpdate: NoAction)

  users     User[]
  auditLogs CityAuditLog[]
  reports   Contribution[]
}

model CityAuditLog {
  id        String          @id @default(auto()) @map("_id") @db.ObjectId
  communeId String          @db.ObjectId
  commune   Commune         @relation(fields: [communeId], references: [id], onDelete: Cascade)
  userId    String?         @db.ObjectId
  user      User?           @relation(fields: [userId], references: [id], onDelete: SetNull)
  action    CityAuditAction
  details   Json?
  createdAt DateTime        @default(now())
}

model UserLoginLog {
  id        String   @id @default(auto()) @map("_id") @db.ObjectId
  userId    String   @db.ObjectId
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  ipAddress String?
  userAgent String?
  createdAt DateTime @default(now())
}

model Contribution {
  id            String             @id @default(auto()) @map("_id") @db.ObjectId
  communeId     String             @db.ObjectId
  commune       Commune            @relation(fields: [communeId], references: [id], onDelete: Cascade)
  type          ContributionType
  status        ContributionStatus @default(OPEN)
  categoryValue String
  categoryLabel String
  subcategory   String
  details       String
  locationLabel String?
  latitude      Float?
  longitude     Float?
  photoUrl      String?
  photoPublicId String?
  createdAt     DateTime           @default(now())
  updatedAt     DateTime           @updatedAt
  closedAt      DateTime?
  closureNote   String?
  closedById    String?            @db.ObjectId
  closedBy      User?              @relation("ContributionClosedBy", fields: [closedById], references: [id], onDelete: SetNull)
}

model BugReport {
  id                 String             @id @default(auto()) @map("_id") @db.ObjectId
  type               BugReportType
  status             BugReportStatus    @default(TO_BE_QUALIFIED)
  title              String
  description        String
  captchaToken       String?
  screenshotUrl      String?
  screenshotPublicId String?
  screenshotWidth    Int?
  screenshotHeight   Int?
  screenshotBytes    Int?
  createdAt          DateTime           @default(now())
  updatedAt          DateTime           @updatedAt
  resolvedAt         DateTime?
  githubCommitUrl    String?
  comments           BugReportComment[]
}

model ContactTicket {
  id            String              @id @default(auto()) @map("_id") @db.ObjectId
  contactType   ContactTicketType
  status        ContactTicketStatus @default(PENDING)
  fingerprint   String
  name          String
  email         String
  function      String
  commune       String?
  organisme     String?
  message       String
  consent       Boolean
  createdAt     DateTime            @default(now())
  updatedAt     DateTime            @updatedAt
  processedAt   DateTime?
  processedById String?             @db.ObjectId
  processedBy   User?               @relation(fields: [processedById], references: [id], onDelete: SetNull, onUpdate: NoAction)

  @@index([status])
  @@index([contactType])
  @@index([createdAt])
  @@index([fingerprint, createdAt])
}

model BugReportComment {
  id          String    @id @default(auto()) @map("_id") @db.ObjectId
  bugReportId String    @db.ObjectId
  bugReport   BugReport @relation(fields: [bugReportId], references: [id], onDelete: Cascade)
  authorId    String?   @db.ObjectId
  author      User?     @relation(fields: [authorId], references: [id], onDelete: SetNull)
  message     String
  createdAt   DateTime  @default(now())

  @@index([bugReportId])
  @@index([createdAt])
}
