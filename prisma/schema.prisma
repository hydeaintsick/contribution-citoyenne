generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "mongodb"
  url      = env("DATABASE_URL")
}

enum Role {
  ADMIN
  ACCOUNT_MANAGER
  TOWN_MANAGER
  TOWN_EMPLOYEE
}

enum ContributionType {
  ALERT
  SUGGESTION
}

enum ContributionStatus {
  OPEN
  CLOSED
}

enum BugReportType {
  BUG
  FEATURE
}

enum BugReportStatus {
  TO_BE_QUALIFIED
  TO_DO
  IN_PROGRESS
  DEPLOYED
  DONE
}

enum ContactTicketType {
  COMMUNE
  ORGANISME_FINANCIER
  MINISTERE_PUBLIC
}

enum ContactTicketStatus {
  PENDING
  RESOLVED
}

enum CityAuditAction {
  CREATED
  UPDATED
}

model User {
  id                String             @id @default(auto()) @map("_id") @db.ObjectId
  email             String             @unique
  password          String
  firstName         String?
  lastName          String?
  phone             String?
  title             String?
  role              Role               @default(ADMIN)
  commune           Commune?           @relation(fields: [communeId], references: [id], onDelete: SetNull, onUpdate: NoAction)
  communeId         String?            @db.ObjectId
  createdAt         DateTime           @default(now())
  updatedAt         DateTime           @updatedAt
  lastLoginAt       DateTime?
  loginLogs         UserLoginLog[]
  cityAuditLogs     CityAuditLog[]
  createdCommunes   Commune[]          @relation("CommuneCreatedBy")
  updatedCommunes   Commune[]          @relation("CommuneUpdatedBy")
  closedReports     Contribution[]     @relation("ContributionClosedBy")
  contactTickets    ContactTicket[]
  bugReportComments BugReportComment[]
  createdNews       News[]             @relation("NewsCreatedBy")
}

model Commune {
  id          String   @id @default(auto()) @map("_id") @db.ObjectId
  name        String
  slug        String?  @unique
  postalCode  String   @unique
  osmId       String   @unique
  osmType     String
  bbox        Float[]
  latitude    Float
  longitude   Float
  country     String   @default("FR")
  websiteUrl  String?
  isVisible   Boolean  @default(true)
  isPartner   Boolean  @default(false)
  safeModeEnabled Boolean @default(false)
  hasPremiumAccess Boolean @default(false)
  webhookUrl  String?
  webhookSecret String?
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  createdById String?  @db.ObjectId
  createdBy   User?    @relation("CommuneCreatedBy", fields: [createdById], references: [id], onDelete: NoAction, onUpdate: NoAction)
  updatedById String?  @db.ObjectId
  updatedBy   User?    @relation("CommuneUpdatedBy", fields: [updatedById], references: [id], onDelete: NoAction, onUpdate: NoAction)

  users     User[]
  auditLogs CityAuditLog[]
  reports   Contribution[]
  newsRead  NewsRead[]
  webhookLogs WebhookLog[]
}

model Category {
  id             String   @id @default(auto()) @map("_id") @db.ObjectId
  name           String
  description    String?
  isActive       Boolean  @default(true)
  badgeColor     String   @default("#000091")
  badgeTextColor String   @default("#ffffff")
  createdAt      DateTime @default(now())
  updatedAt      DateTime @updatedAt

  contributions Contribution[]

  @@unique([name])
  @@index([isActive])
}

model CityAuditLog {
  id        String          @id @default(auto()) @map("_id") @db.ObjectId
  communeId String          @db.ObjectId
  commune   Commune         @relation(fields: [communeId], references: [id], onDelete: Cascade)
  userId    String?         @db.ObjectId
  user      User?           @relation(fields: [userId], references: [id], onDelete: SetNull)
  action    CityAuditAction
  details   Json?
  createdAt DateTime        @default(now())
}

model UserLoginLog {
  id        String   @id @default(auto()) @map("_id") @db.ObjectId
  userId    String   @db.ObjectId
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  ipAddress String?
  userAgent String?
  createdAt DateTime @default(now())
}

model Contribution {
  id            String             @id @default(auto()) @map("_id") @db.ObjectId
  communeId     String             @db.ObjectId
  commune       Commune            @relation(fields: [communeId], references: [id], onDelete: Cascade)
  type          ContributionType
  status        ContributionStatus @default(OPEN)
  categoryId    String?            @db.ObjectId
  category      Category?          @relation(fields: [categoryId], references: [id], onDelete: SetNull)
  categoryLabel String
  title         String             @default("")
  details       String
  locationLabel String?
  latitude      Float?
  longitude     Float?
  photoUrl      String?
  photoPublicId String?
  email         String?
  ticketNumber  String?            @unique
  createdAt     DateTime           @default(now())
  updatedAt     DateTime           @updatedAt
  closedAt      DateTime?
  closureNote   String?
  closedById    String?            @db.ObjectId
  closedBy      User?              @relation("ContributionClosedBy", fields: [closedById], references: [id], onDelete: SetNull)
  isPotentiallyMalicious Boolean   @default(false)
}

model BugReport {
  id                 String             @id @default(auto()) @map("_id") @db.ObjectId
  type               BugReportType
  status             BugReportStatus    @default(TO_BE_QUALIFIED)
  title              String
  description        String
  captchaToken       String?
  screenshotUrl      String?
  screenshotPublicId String?
  screenshotWidth    Int?
  screenshotHeight   Int?
  screenshotBytes    Int?
  createdAt          DateTime           @default(now())
  updatedAt          DateTime           @updatedAt
  resolvedAt         DateTime?
  githubCommitUrl    String?
  comments           BugReportComment[]
}

model ContactTicket {
  id            String              @id @default(auto()) @map("_id") @db.ObjectId
  contactType   ContactTicketType
  status        ContactTicketStatus @default(PENDING)
  fingerprint   String
  name          String
  email         String
  function      String
  commune       String?
  organisme     String?
  message       String
  consent       Boolean
  createdAt     DateTime            @default(now())
  updatedAt     DateTime            @updatedAt
  processedAt   DateTime?
  processedById String?             @db.ObjectId
  processedBy   User?               @relation(fields: [processedById], references: [id], onDelete: SetNull, onUpdate: NoAction)

  @@index([status])
  @@index([contactType])
  @@index([createdAt])
  @@index([fingerprint, createdAt])
}

model BugReportComment {
  id          String    @id @default(auto()) @map("_id") @db.ObjectId
  bugReportId String    @db.ObjectId
  bugReport   BugReport @relation(fields: [bugReportId], references: [id], onDelete: Cascade)
  authorId    String?   @db.ObjectId
  author      User?     @relation(fields: [authorId], references: [id], onDelete: SetNull)
  message     String
  createdAt   DateTime  @default(now())

  @@index([bugReportId])
  @@index([createdAt])
}

model News {
  id          String    @id @default(auto()) @map("_id") @db.ObjectId
  title       String
  content     String
  isActive    Boolean   @default(true)
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt
  createdById String    @db.ObjectId
  createdBy   User      @relation("NewsCreatedBy", fields: [createdById], references: [id], onDelete: NoAction, onUpdate: NoAction)
  reads       NewsRead[]

  @@index([isActive])
  @@index([createdAt])
}

model NewsRead {
  id        String   @id @default(auto()) @map("_id") @db.ObjectId
  newsId    String   @db.ObjectId
  news      News     @relation(fields: [newsId], references: [id], onDelete: Cascade)
  communeId String   @db.ObjectId
  commune   Commune  @relation(fields: [communeId], references: [id], onDelete: Cascade)
  readAt    DateTime @default(now())

  @@unique([newsId, communeId])
  @@index([communeId])
  @@index([newsId])
}

model WebhookLog {
  id            String    @id @default(auto()) @map("_id") @db.ObjectId
  communeId     String    @db.ObjectId
  commune       Commune   @relation(fields: [communeId], references: [id], onDelete: Cascade)
  url           String
  statusCode    Int?
  success       Boolean
  errorMessage  String?
  responseTime  Int?
  contributionId String?  @db.ObjectId
  isTest        Boolean   @default(false)
  createdAt     DateTime  @default(now())

  @@index([communeId])
  @@index([createdAt])
  @@index([isTest])
}
